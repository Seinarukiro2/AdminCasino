{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
    <a href="{% url 'project_list' %}" class="btn btn-secondary mb-3">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º
    </a>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ -->
    <h1>{{ project.project_name }}</h1>
    
    <br><strong>Bot Token:</strong> 
    <span id="botTokenText" style="cursor: pointer;" data-bs-toggle="tooltip" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è">
        {{ project.bot_token }}
    </span>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tokenText = document.getElementById('botTokenText');

            // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø–æ –∫–ª–∏–∫—É
            tokenText.addEventListener('click', function() {
                navigator.clipboard.writeText(tokenText.textContent).then(function() {

                }).catch(function(error) {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', error);
                });
            });
        });
    </script>
    <p><strong>Web App URL:</strong> {{ project.webapp_url }}</p>
    <p><strong>Bot Username:</strong> {{ project.bot_username }}</p>
    <p><strong>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç:</strong> <a href="{{ project.project_link }}" target="_blank">{{ project.project_link }}</a></p>
    <p><strong>MAC-–∞–¥—Ä–µ—Å:</strong> {{ project.mac }}</p>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProjectModal">
        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
    </button>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <button type="button" class="btn btn-outline-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">
        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
    </button>

    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#botSettingsModal">
        ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
    </button>


    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞ -->
<div class="modal fade" id="botSettingsModal" tabindex="-1" aria-labelledby="botSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="botSettingsModalLabel">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'update_bot_settings' project.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bot_token" class="form-label">Bot Token</label>
                        <input type="text" class="form-control" id="bot_token" name="bot_token" value="{{ project.bot_token }}" readonly>
                        <button type="button" class="btn btn-outline-primary mt-2" id="editBotTokenButton">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
                    </div>
                    <div class="mb-3">
                        <label for="start_message" class="form-label">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                        <textarea class="form-control" id="start_message" name="start_message" rows="3">{{ project.start_message }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                <div id="alertContainer" class="mt-3"></div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" id="startBotButton">–†–∞–Ω –±–æ—Ç</button>
                <button type="button" class="btn btn-outline-warning" id="restartBotButton">–†–µ—Å—Ç–∞—Ä—Ç –±–æ—Ç</button>
                <button type="button" class="btn btn-outline-danger" id="stopBotButton">–°—Ç–æ–ø –±–æ—Ç</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showAlert(message, type) {
        // –¢–∏–ø—ã: success, danger, warning, info
        const alertContainer = document.getElementById('alertContainer');
        const alertBox = document.createElement('div');
        alertBox.className = `alert alert-${type} alert-dismissible fade show`;
        alertBox.role = "alert";
        alertBox.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        alertContainer.appendChild(alertBox);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            alertBox.remove();
        }, 5000);
    }
    document.getElementById('editBotTokenButton').addEventListener('click', function() {
        const botTokenInput = document.getElementById('bot_token');
        botTokenInput.readOnly = !botTokenInput.readOnly;
    });

    document.getElementById('startBotButton').addEventListener('click', function() {
    // –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        fetch(`/start_bot/{{ project.id }}/`, { method: 'POST' }).then(response => {
            if (response.ok) {
                showAlert('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω', 'success');
            } else {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞', 'danger');
            }
        });
    });

    document.getElementById('restartBotButton').addEventListener('click', function() {
        // –†–µ—Å—Ç–∞—Ä—Ç –±–æ—Ç–∞
        fetch(`/restart_bot/${project.id}`, { method: 'POST' }).then(response => {
            if (response.ok) {
                alert('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞');
            }
        });
    });

    document.getElementById('stopBotButton').addEventListener('click', function() {
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
        fetch(`/stop_bot/${project.id}`, { method: 'POST' }).then(response => {
            if (response.ok) {
                alert('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞');
            }
        });
    });
</script>

    <!-- –ü–æ–ø–∞–ø –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProjectModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{% url 'project_detail' project.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="project_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                            <input type="text" class="form-control" id="project_name" name="project_name" value="{{ project.project_name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="project_link" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç</label>
                            <input type="url" class="form-control" id="project_link" name="project_link" value="{{ project.project_link }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="mac" class="form-label">MAC-–∞–¥—Ä–µ—Å</label>
                            <input type="text" class="form-control" id="mac" name="mac" value="{{ project.mac }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="bot_username" class="form-label">Bot Username</label>
                            <input type="text" class="form-control" id="bot_username" name="bot_username" value="{{ project.bot_username|default:'@' }}">
                        </div>                        
                        <div class="mb-3">
                            <label for="bot_token" class="form-label">Bot Token</label>
                            <input type="text" class="form-control" id="bot_token" name="bot_token" value="{{ project.bot_token|default:'' }}">
                        </div>
                        <div class="mb-3">
                            <label for="webapp_url" class="form-label">Web App URL</label>
                            <input type="url" class="form-control" id="webapp_url" name="webapp_url" value="{{ project.webapp_url|default:'' }}">
                        </div>
                        <div class="mb-3">
                            <label for="hall_id" class="form-label">Hall ID</label>
                            <input type="number" class="form-control" id="hall_id" name="hall_id" value="{{ project.hall_id }}" disabled>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    

    <!-- –ü–æ–ø–∞–ø –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteProjectModalLabel">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç? –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º, –æ—Å—Ç–∞–Ω—É—Ç—Å—è, –Ω–æ –∏—Ö Hall ID –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É –±—É–¥—É—Ç –æ—á–∏—â–µ–Ω—ã.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ù–µ—Ç</button>
                    <form method="POST" action="{% url 'delete_project' project.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–µ–∫—Ç–æ–º -->
    <h2 class="mt-5">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–µ–∫—Ç–æ–º</h2>
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Login</th>
                <th>Hidden Login</th>
                <th>Hall ID</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.login }}</td>
                    <td>{{ user.hidden_login }}</td>
                    <td>{{ user.hall_id }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="text-center">–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
